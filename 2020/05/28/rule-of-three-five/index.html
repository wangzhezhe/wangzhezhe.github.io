<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>rule of three/five | Wangzhezhe&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="discuss the rule of three/five in cpp.">
<meta property="og:type" content="article">
<meta property="og:title" content="rule of three&#x2F;five">
<meta property="og:url" content="http://yoursite.com/2020/05/28/rule-of-three-five/index.html">
<meta property="og:site_name" content="Wangzhezhe&#39;s Blog">
<meta property="og:description" content="discuss the rule of three/five in cpp.">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2020-05-28T15:56:28.095Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="rule of three&#x2F;five">
<meta name="twitter:description" content="discuss the rule of three/five in cpp.">
  
    <link rel="alternate" href="/atom.xml" title="Wangzhezhe&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    
  
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-165927341-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    
    <div id="header-inner" class="inner">
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">首页</a>
        
          <a class="main-nav-link" href="/archives">归档</a>
        
          <a class="main-nav-link" href="/about">关于</a>
        
      </nav>
      
    </div>
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Wangzhezhe&#39;s Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Writing is nature&#39;s way of letting you know how sloppy your thinking is.</a>
        </h2>
      
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-rule-of-three-five" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/05/28/rule-of-three-five/" class="article-date">
  <time datetime="2020-05-28T15:53:38.000Z" itemprop="datePublished">2020-05-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/c-c/">c/c++</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      rule of three/five
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <p>discuss the rule of three/five in cpp.</p>
<a id="more"></a>
<p>When we start to define a class or a struct, if we do not follow the rule of three or rule of five, we might got some potential problems when the code becomes complicated.</p>
<p>For me, it seems that I would prefer to use the stack variable compared with the pointer to the class. Some times I may try to use <code>SomeClass *a =new SomeClass</code>, then I may forget to call the <code>delete a</code> sometimes. I would take some time to reorganize the code in order to avoid to use the class/struct pointer, unless it is necessary. I noticed that one reason that push me to use the poiter and the heap allocation to the class is that I may not need to follow the rule of three, for example, I could declare the dedicated struct or class instance in heap and acquire it by pointer, then I put these pointer into STL such as queue and map for further processing.</p>
<p>Although it works sometimes, but it is pretty like the c style. If the code gets comlicated, some memory problems appear and that make the code a little bit hard to maintain. Following the rule of three can avoid this issue and make the code looks more cleaning and tight.</p>
<h3 id="rule-of-three"><a href="#rule-of-three" class="headerlink" title="rule of three"></a>rule of three</h3><p>rule of three means that following three functions for struct or class must be provided: destructor, copy constructor, copy assignment operator. For copy constructor, it will be used when you init a struct/class instance by another class instance. For the copu assignmnet operator, it supports to the operation such as <code>SomeClass a = instanceOfA</code>. If one of these functions is used without first being declared by the programmer, it will be implicitly implemented by the compiler. Attention, the compiler generated version is based on the shadow copy, if there are some pointer value in the struct, you may need to set these special functions manually. Otherwise, it might cause the problem of the double free such like <a href="http://www.cplusplus.com/forum/general/29640/" target="_blank" rel="noopener">this case</a>. there is one block of the memory but there are two points, therefore, it might cause the double free problems. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;iostream&gt;</span><br><span class="line">#include &lt;vector&gt;</span><br><span class="line"></span><br><span class="line">struct foo&#123;</span><br><span class="line">    std::string f1;</span><br><span class="line">    std::vector&lt;int&gt; v1;</span><br><span class="line">     foo()&#123;</span><br><span class="line">         std::cout&lt;&lt;&quot;foo is constructed&quot;&lt;&lt;std::endl;</span><br><span class="line">         f1=&quot;construct test&quot;;</span><br><span class="line">         v1.push_back(666);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     foo(const foo&amp; f)&#123;</span><br><span class="line">         std::cout&lt;&lt;&quot;copy constructor is called&quot;&lt;&lt;std::endl;</span><br><span class="line">         f1=&quot;copy test&quot;;</span><br><span class="line">         v1.push_back(888); </span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">    foo&amp; operator = (const foo &amp;t) &#123;</span><br><span class="line">        std::cout&lt;&lt;&quot;assignment operator is called&quot;&lt;&lt;std::endl;</span><br><span class="line">        this-&gt;f1=&quot;assignment test &quot; + t.f1;</span><br><span class="line">        this-&gt;v1[0]=999; </span><br><span class="line">        return *this;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~foo()&#123;std::cout&lt;&lt;&quot;foo is destructed automatically when foo is outof scope&quot;&lt;&lt;std::endl;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">void test ()&#123;</span><br><span class="line">    foo f = foo();</span><br><span class="line"></span><br><span class="line">    //defualt copy operator</span><br><span class="line">    foo g = f;</span><br><span class="line">    //check the value of the g</span><br><span class="line">    std::cout &lt;&lt; &quot;check the value g: &quot;&lt;&lt; g.f1&lt;&lt; &quot;,&quot; &lt;&lt; g.v1[0] &lt;&lt;std::endl;</span><br><span class="line">    </span><br><span class="line">    //copy constructor </span><br><span class="line">    foo i;</span><br><span class="line">    std::cout &lt;&lt; &quot;default constructor check the value i: &quot;&lt;&lt; i.f1&lt;&lt; &quot;,&quot; &lt;&lt; i.v1[0] &lt;&lt;std::endl;</span><br><span class="line"></span><br><span class="line">    //assignment constructor </span><br><span class="line">    i = f;</span><br><span class="line">    std::cout &lt;&lt; &quot;after copy check the value i: &quot;&lt;&lt; i.f1&lt;&lt; &quot;,&quot; &lt;&lt; i.v1[0] &lt;&lt;std::endl;</span><br><span class="line"></span><br><span class="line">    return;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main()&#123;</span><br><span class="line">    test();</span><br><span class="line">    std::cout&lt;&lt;&quot;main finish&quot;&lt;&lt;std::endl;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//////output//////</span><br><span class="line">foo is constructed</span><br><span class="line">copy constructor is called</span><br><span class="line">check the value g: copy test,888</span><br><span class="line">foo is constructed</span><br><span class="line">default constructor check the value i: construct test,666</span><br><span class="line">assignment operator is called</span><br><span class="line">after copy check the value i: assignment test construct test,999</span><br><span class="line">foo is destructed automatically when foo is outof scope</span><br><span class="line">foo is destructed automatically when foo is outof scope</span><br><span class="line">foo is destructed automatically when foo is outof scope</span><br><span class="line">main finish</span><br></pre></td></tr></table></figure>
<p>according to this case, when the class is initializsed, the default constructor or the copy constructor is called. When two instances are initialized and one instance could get value from another instance, the assignment constructor will be called. The destructor will be called when the instance is out of the scope.</p>
<p>If you want the struct as the key or value of specific STL such as the map, you also need to declare other operator such as “&lt;” operation.</p>
<h3 id="the-rule-of-five"><a href="#the-rule-of-five" class="headerlink" title="the rule of five"></a>the rule of five</h3><p>After the c++11, more rules are added into the class declaration, these rules are usually called rule of five.</p>
<p>This is a <a href="https://cpppatterns.com/patterns/rule-of-five.html" target="_blank" rel="noopener">good reference</a>. The main complicated part is the notation of the <code>&amp;&amp;</code>, two functions added here are <code>move constructor</code> and <code>move assignment operator</code>. </p>
<p>We need to figure out the lvalue and the rvalue before discussing more details. <a href="https://josephmansfield.uk/articles/lvalue-rvalue-metaphor.html" target="_blank" rel="noopener">this article</a> provides a good explanation.</p>
<p>So the <code>&amp;&amp;</code> represents the rvalue in cpp. and the last two rules are necessary if we use the move semantics. The original become unavalible after using the move related semantics.</p>
<p>This <a href="https://www.educative.io/edpresso/what-is-a-move-constructor-in-cpp" target="_blank" rel="noopener">article</a> provides a good explanation about why we need to use the rvalue and the move semantics. The main reason is to avoid the performance overhead, since the object is constructed for the orignal case when we execute the copy operation. Basically, there are two opeject, you assign values of one object two another, then both of them are deleted at last. But essentially, when you execute operations such as put a instance into a vector, you may want to provide a new view from the data structure’s view. The original instance might not useful anymore. In that case, in the move constructor, you just need to transfer the ownership of the data from the original instance to the new instance to avoid the extra data copy operation. Then the original instance become invalid. But the two destructors are also need to be called when the program is out of the scope. </p>
<h3 id="references"><a href="#references" class="headerlink" title="references"></a>references</h3><p>why to use the rvalue<br><a href="https://www.educative.io/edpresso/what-is-a-move-constructor-in-cpp" target="_blank" rel="noopener">https://www.educative.io/edpresso/what-is-a-move-constructor-in-cpp</a></p>
<p>problem of double free (use reference instead of copy)</p>
<p><a href="http://www.cplusplus.com/forum/general/29640/" target="_blank" rel="noopener">http://www.cplusplus.com/forum/general/29640/</a> </p>
<p>assignment operator vs copy constructor</p>
<p><a href="https://www.geeksforgeeks.org/copy-constructor-vs-assignment-operator-in-c/" target="_blank" rel="noopener">https://www.geeksforgeeks.org/copy-constructor-vs-assignment-operator-in-c/</a></p>
<p>the rule of zero, five, or maybe six.</p>
<p><a href="https://www.modernescpp.com/index.php/c-core-guidelines-constructors-assignments-and-desctructors" target="_blank" rel="noopener">https://www.modernescpp.com/index.php/c-core-guidelines-constructors-assignments-and-desctructors</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/05/28/rule-of-three-five/" data-id="ckaqymvi7001zbk85updfaf4v" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
    
 <script src="/jquery/jquery.min.js"></script>
  <div id="random_posts">
    <h2>推荐文章</h2>
    <div class="random_posts_ul">
      <script>
          var random_count =4
          var site = {BASE_URI:'/'};
          function load_random_posts(obj) {
              var arr=site.posts;
              if (!obj) return;
              // var count = $(obj).attr('data-count') || 6;
              for (var i, tmp, n = arr.length; n; i = Math.floor(Math.random() * n), tmp = arr[--n], arr[n] = arr[i], arr[i] = tmp);
              arr = arr.slice(0, random_count);
              var html = '<ul>';
            
              for(var j=0;j<arr.length;j++){
                var item=arr[j];
                html += '<li><strong>' + 
                item.date + ':&nbsp;&nbsp;<a href="' + (site.BASE_URI+item.uri) + '">' + 
                (item.title || item.uri) + '</a></strong>';
                if(item.excerpt){
                  html +='<div class="post-excerpt">'+item.excerpt+'</div>';
                }
                html +='</li>';
                
              }
              $(obj).html(html + '</ul>');
          }
          $('.random_posts_ul').each(function () {
              var c = this;
              if (!site.posts || !site.posts.length){
                  $.getJSON(site.BASE_URI + 'js/posts.js',function(json){site.posts = json;load_random_posts(c)});
              } 
               else{
                load_random_posts(c);
              }
          });
      </script>
    </div>
  </div>

    
<nav id="article-nav">
  
  
    <a href="/2020/04/24/single-core-with-multithreading/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">single core with multiprocess</div>
    </a>
  
</nav>

  
</article>
 
     
  <div class="comments" id="comments">
    
     
       
      <div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
    
       
      
      
  </div>
 
  

</section>
           
    <aside id="sidebar">
  
    
    <div class="widget-wrap">
    
      <div class="widget" id="toc-widget-fixed">
      
        <strong class="toc-title">文章目录</strong>
        <div class="toc-widget-list">
              <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#rule-of-three"><span class="toc-number">1.</span> <span class="toc-text">rule of three</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#the-rule-of-five"><span class="toc-number">2.</span> <span class="toc-text">the rule of five</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#references"><span class="toc-number">3.</span> <span class="toc-text">references</span></a></li></ol>
          </div>
      </div>
    </div>

  
    

  
    
  
    
  
    

  
</aside>

      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-left">
      &copy; 2014 - 2020 zhe&nbsp;|&nbsp;
      主题 <a href="https://github.com/giscafer/hexo-theme-cafe/" target="_blank">Cafe</a>
    </div>
     <div id="footer-right">
      联系方式&nbsp;|&nbsp;godenwangzhe@gmail.com
    </div>
  </div>
</footer>
 <script src="/jquery/jquery.min.js"></script>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
    <a href="/about" class="mobile-nav-link">关于</a>
  
</nav>
    <img class="back-to-top-btn" src="/images/fly-to-top.png"/>
<script>
// Elevator script included on the page, already.
window.onload = function() {
  var elevator = new Elevator({
    selector:'.back-to-top-btn',
    element: document.querySelector('.back-to-top-btn'),
    duration: 1000 // milliseconds
  });
}
</script>
      

  
    <script>
      var cloudTieConfig = {
        url: document.location.href, 
        sourceId: "",
        productKey: "e2fb4051c49842688ce669e634bc983f",
        target: "cloud-tie-wrapper"
      };
    </script>
    <script src="https://img1.ws.126.net/f2e/tie/yun/sdk/loader.js"></script>
    

  







<!-- author:forvoid begin -->
<!-- author:forvoid begin -->

<!-- author:forvoid end -->

<!-- author:forvoid end -->


  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      })
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      })
    </script>
    <script type="text/javascript" src="https://cdn.rawgit.com/mathjax/MathJax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


 <script src="/js/is.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<script src="/js/elevator.js"></script>
  </div>
</body>
</html>