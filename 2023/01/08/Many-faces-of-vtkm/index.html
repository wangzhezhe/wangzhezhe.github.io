<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Many faces of vtkm | AverageMind</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="I use vtkm a lot for all kinds of projects, this article includes some tips and thoughts about using the vtkm from the perspective of software design.">
<meta property="og:type" content="article">
<meta property="og:title" content="Many faces of vtkm">
<meta property="og:url" content="http://yoursite.com/2023/01/08/Many-faces-of-vtkm/index.html">
<meta property="og:site_name" content="AverageMind">
<meta property="og:description" content="I use vtkm a lot for all kinds of projects, this article includes some tips and thoughts about using the vtkm from the perspective of software design.">
<meta property="og:locale">
<meta property="article:published_time" content="2023-01-08T20:41:08.000Z">
<meta property="article:modified_time" content="2024-01-10T04:13:04.566Z">
<meta property="article:author" content="zhe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="AverageMind" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    
  
  
<link rel="stylesheet" href="/css/style.css">

  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-165927341-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


  
<!-- Google adds -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5642436380582343"
     crossorigin="anonymous">
</script>
<!-- End Google adds -->




<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    
    <div id="header-inner" class="inner">
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">首页</a>
        
          <a class="main-nav-link" href="/archives">归档</a>
        
          <a class="main-nav-link" href="/about">关于</a>
        
      </nav>
      
    </div>
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">AverageMind</a>
      </h1>
      
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Many-faces-of-vtkm" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2023/01/08/Many-faces-of-vtkm/" class="article-date">
  <time datetime="2023-01-08T20:41:08.000Z" itemprop="datePublished">2023-01-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Visualization/">Visualization</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Many faces of vtkm
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <p>I use vtkm a lot for all kinds of projects, this article includes some tips and thoughts about using the vtkm from the perspective of software design.</p>
<span id="more"></span>

<p>The original paper of vtkm is this one</p>
<p><a target="_blank" rel="noopener" href="https://www.kennethmoreland.com/documents/VTKmCGA2016.pdf">https://www.kennethmoreland.com/documents/VTKmCGA2016.pdf</a></p>
<p>Pattens that the algorithm follows for parallel running is this one:</p>
<p><a target="_blank" rel="noopener" href="https://sdm.lbl.gov/sdav/images/publications/Mor2013b/MassivelyThreadedVis.pdf">https://sdm.lbl.gov/sdav/images/publications/Mor2013b/MassivelyThreadedVis.pdf</a></p>
<p>Most of the topics can be found under the change log repo <a target="_blank" rel="noopener" href="https://gitlab.kitware.com/vtk/vtk-m/-/tree/master/docs">here</a>.</p>
<h3 id="Decouple-between-the-execution-env-and-control-env"><a href="#Decouple-between-the-execution-env-and-control-env" class="headerlink" title="Decouple between the execution env and control env"></a>Decouple between the execution env and control env</h3><p>One important thing is to figure out how to set the <code>ControlSignature</code>, <code>ExecutionSignature</code> and parameters of operator function in the worklet type. It seems that all worklet in vtkm style follows this style.</p>
<p>There are some detailed explanatio in the vtkm userguide 17.1-17.4, the parameters specified by exeutionSignature shows which parameters are chosen to execute in the exec env. Parameters specified in the operator function should match with the type of parameters specified in exec env (including the type of the template parameter). It seems that the template parameters can be reused? Not sure how it works here, but it works. If two parameters use the same type, we only need one input template parameter. </p>
<h3 id="Filter-plus-worklet-style"><a href="#Filter-plus-worklet-style" class="headerlink" title="Filter plus worklet style"></a>Filter plus worklet style</h3><p>If we just use the worklet based on specific data sets or array, the things described about can satisfy our requirments, and we need to create the dispatcher separately. Then call the invoker function of based on worklet.</p>
<p>Another level of abstraction is the filter. we need to send the data in and return the data and hidden the details. There are multiple filters in vtkm, the base class is sth like <code>vtkm::filter::FilterField</code>, we can call the invoke function direactly if the filter is inherited from that base class, this is an <a target="_blank" rel="noopener" href="https://gitlab.kitware.com/vtk/vtk-m/-/blob/master/tutorial/point_to_cell.cxx">example</a>. We inherite from that base class and call <code>this-&gt;Invoke</code> direactly.</p>
<p>The filter base class provids more simple things to do the dispatcher, invoke and detect the type of input and output type.</p>
<p>The case of multiple input and the multiple output.</p>
<h3 id="Type-detect-and-conversion"><a href="#Type-detect-and-conversion" class="headerlink" title="Type detect and conversion"></a>Type detect and conversion</h3><p>The core idea is the type tranform here is to let the code can work on different types. The strategies used in vtkm is the runtime transform. The idea is that the deduce the type of a particular field, and then they use that field as the template parameter.</p>
<p>How to deduce the type of a specific array in runtime? The idea is specify a type list and then compare your type with that list to see which is accurate one. In this <a target="_blank" rel="noopener" href="https://gitlab.kitware.com/vtk/vtk-m/-/blob/master/vtkm/cont/UnknownArrayHandle.h">array handle</a> there are all kinds of functions start with <code>CastAndCallFor...</code> this can be used at different scenarios. The deduced array type is usually set as an input variable of a lambda expression.</p>
<p>There are different versions of the castandcall function, it will cast the input into the specific type. There is actually a tradeoff between known types and the actual type. If we do not put limitation on input type, there might be too many template generated when creating the actual implementation. Different cast and call type can add these assumptions. For example, <code>CastAndCallScalarField</code> is only works for the types in <code>TypeListFieldScalar</code>.</p>
<p>If you really want your function to work with all types, you can use a different version of CastAndCall that will check for all types. It would look something like this: </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">inField.GetData().CastAndCallWithTypes&lt;vtkm::TypeListScalarAll, VTKM_DEFAULT_STORAGE_LIST&gt;(resolveType2d)</span><br></pre></td></tr></table></figure>
<p>We could always refer to implementaitons of vtkm filters to see how the cast and call are used in different scenarios.</p>
<p>If there are multiple variable, the solution of the vtkm is to use the type of specific variable to infer the type of other type. They have an function called <code>ArrayCopyShallowIfPossible</code>, the typical scenario is sth like this:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//use decay_t to remove the const qulifier</span></span><br><span class="line"><span class="keyword">using</span> T = <span class="keyword">typename</span> std::<span class="type">decay_t</span>&lt;<span class="keyword">decltype</span>(inputArray)&gt;::ValueType;</span><br><span class="line">vtkm::cont::ArrayHandle&lt;T&gt; inFieldMin;</span><br><span class="line">vtkm::cont::<span class="built_in">ArrayCopyShallowIfPossible</span>(inData.<span class="built_in">GetField</span>(<span class="string">&quot;ensemble_min&quot;</span>).<span class="built_in">GetData</span>(), inFieldMin);</span><br></pre></td></tr></table></figure>

<p>If they have the same type, the do the shallow copy, the <code>T</code> is the deduced type.</p>
<p>Another commonly used function to convert the array type is the <code>AsArrayHandle</code>, if we search this keyword on the gitlab page of the vtkm, there are all kinds of examples and test case </p>
<p>In this file that defines the <a target="_blank" rel="noopener" href="https://gitlab.kitware.com/vtk/vtk-m/-/blob/master/vtkm/cont/UnknownArrayHandle.h">ArrayHandle</a>, it defines specific behaviours for the <code>AsArrayHandle</code>, the idea is to use the <code>decltype</code> to get the target type and to check if it is ok to do the conversion, if it is ok, we then use the <code>reinterpret_cast</code> to do the conversion. For the cellset, there are also some function such as <code>AsCellSet</code> to cast the unknown cellset into the specific one.</p>
<p>This <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/573294/when-to-use-reinterpret-cast">question</a> discusses some details regarding why use this kind of general type. The interface want to be desgined as general as possible, for example such as get cell set in vtkm, it can be desgined to have a get cell set function for each pecific type of cell set, it needs to have some kind of generality. We may imagine the unknown cell set or array type is a kind of interface for the concrete member.</p>
<h3 id="CastAndCall-and-ListForEach"><a href="#CastAndCall-and-ListForEach" class="headerlink" title="CastAndCall and ListForEach"></a>CastAndCall and ListForEach</h3><p>There are multiple options to do this type conversion in VTK-m, the better ones depend on the situation.</p>
<p><code>CastAndCallForTypes</code> needs to consider both the element type and storage type of the arrayhandle. Just looking at the Section about the customized array handle. For arrayHandle, it is generalized in two aspects, one is the basic type such as int, double etc. Another is underlying storage type such as basic and SOA array. The StorageList.h in vtkm repo contains associated types.</p>
<p><code>ListForEach</code> just need to get the base component type of the array. We do not need to consider the storage type for this. It needs to be used together with the ExtractComponent. One specific documentation can be found here (<a target="_blank" rel="noopener" href="https://gitlab.kitware.com/vtk/vtk-m/-/blob/master/docs/changelog/1.6/release-notes.md">https://gitlab.kitware.com/vtk/vtk-m/-/blob/master/docs/changelog/1.6/release-notes.md</a>).</p>
<p><a target="_blank" rel="noopener" href="https://gitlab.kitware.com/vtk/vtk-m/-/blob/b59580bb821a7c279429cff7caf98fc067cf181d/vtkm/filter/field_transform/CompositeVectors.cxx">CompositeVector</a> is a good use case for thie ExtractComponent. It is really flexible and the output array can be put into a dynamic array handle. But I am still not quite sure about how to use these things properly. </p>
<h3 id="Other-magics-of-the-array-handle"><a href="#Other-magics-of-the-array-handle" class="headerlink" title="Other magics of the array handle"></a>Other magics of the array handle</h3><p>One thing that contains a steep learning curve is the arrayhandle, since vtkm maintain there own version of arrayhandle, and all other datasets are built over this arary handle, getting familiar with its API is important to use vtkm related operations flexibally.</p>
<p>Write data and get data. getting and writting data need to through the WritePortal and GetPortal, maybe the goal of this is to hide the different underlying data structure, such as CPU array and GPU array. Be careful, it is time consuming to get get&#x2F;write portal multiple times in the for loop.</p>
<p>The arrayHandle is just a pointer essentially, so the shallow copy is eveywhere (even for the dataset based on the arrayhandle) in vtkm unless the explicit copy operation is called.</p>
<p>Checking the type of the value stored in the unknown array handle :  <code>UnknownArrayHandle::ExtractComponent</code> will return an <code>ArrayHandleStride</code> for a particular component. This allows you to get the data, usually without a copy, by just looking at the base component type (check <code>UnknownArrayHandle::IsBaseComponentType&lt;T&gt;()</code>). For this, you only have to check the basic C types of the components (i.e., <code>float</code>, <code>double</code>, <code>int</code>, etc. a.k.a. <code>vtkm::Float32</code>, <code>vtkm::Float64</code>, <code>vtkm::Int32</code>, etc.). That is a tractable set of types to check, which is why we have this feature.</p>
<p>AOS or SOA array.</p>
<h3 id="Call-the-worklet"><a href="#Call-the-worklet" class="headerlink" title="Call the worklet"></a>Call the worklet</h3><p>The idea is the combination between the lambda expression and the type deduction.</p>
<p>This is a <a target="_blank" rel="noopener" href="https://gitlab.kitware.com/vtk/vtk-m/-/blob/master/vtkm/filter/field_transform/PointElevation.cxx">typical exmaple</a></p>
<p>using the <code>CastAndCallVecField</code> can get the correct type.</p>
<p>Another case is that we do not know the type. It will change the concrete type in the lambda expression. such as <a target="_blank" rel="noopener" href="https://gitlab.kitware.com/vtk/vtk-m/-/blob/master/vtkm/filter/contour/ClipWithField.cxx#L55">this example</a>, the <code>CastAndCallForTypesWithFloatFallback</code> will do the actual cast tranform and it will try to compare with the list defined in the first parameter and to see wich inner type can match. Since when we call the GetData, it returns the unknown type. The common use case scenarios is to use the input data type to deduct the output type.</p>
<p>In the lambda expression, it usually declares a dispatcher and then use the Invoke function of the dispatcher to call the worklet, the code in this part follows a similar structure.</p>
<p>More detialed about the type case is described in the previous section. Be careful about the dynamic type conversion here. In one previous code, I do things like this:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">auto inField1 = inData.GetField(&quot;field1&quot;)</span><br><span class="line">auto inField2 = inData.GetField(&quot;field2&quot;)</span><br><span class="line">auto inField3 = inData.GetField(&quot;field3&quot;)</span><br><span class="line">...</span><br><span class="line">declare dispatcher</span><br><span class="line">dispatvher.Invoke(inData.GetCellSet(), inField1, infiedl2, inField3, outArray)</span><br></pre></td></tr></table></figure>
<p>In this way, we did not actually cast the field to specific concrete type, the field will do some innter operation to compare at least 10 types in vtkm, so there are totally 10^3 combinations, which cause really long compiling time. The good practive is always to use cast and call to convert the field into the fixed type based on some assumptions. Or at least we compare the type with all possible type for one field, and then for other field, we can assume they have same field with the first one based on <code>ShallowCopyIfPossible</code>, the example can be found in the previous paragraph.</p>
<h3 id="Create-data-set-for-sample-testing"><a href="#Create-data-set-for-sample-testing" class="headerlink" title="Create data set for sample testing"></a>Create data set for sample testing</h3><p>Although there are flexible libraries in vtkm to imput and output data based on the vtk format, sometimes it is conveneint to build data direactly for simple testing, such as building a structured data. The assocaited code is at the vtkm&#x2F;cont&#x2F;DataSetBuilderxx, there are all kinds of exmaples such as build uniform and rectilinear example. We can refer to these examples to see how to add coordinates and cellset when we need to create a new vtkm dataset for specific goals.</p>
<h3 id="Visulization-with-data-parallel-primitives"><a href="#Visulization-with-data-parallel-primitives" class="headerlink" title="Visulization with data parallel primitives"></a>Visulization with data parallel primitives</h3><p>Or so called parallel skeletons:</p>
<p>The general types of the gpu primitives:</p>
<p>Map (scan operation or add operation, stencil is also a kind of operator)<br>Reduce (output is a single value, sum)<br>Scan (stor intermidiate results)<br>Sort (reordering operation)<br>Search (find index)</p>
<p>One paper regarding the VTKM design, the idea of using the parallel primitives (<a target="_blank" rel="noopener" href="https://cdux.cs.uoregon.edu/pubs/MorelandPARCO.pdf">https://cdux.cs.uoregon.edu/pubs/MorelandPARCO.pdf</a>)</p>
<h3 id="Flexible-and-zero-copy-array-handle"><a href="#Flexible-and-zero-copy-array-handle" class="headerlink" title="Flexible and zero-copy array handle"></a>Flexible and zero-copy array handle</h3><p>If you try to find the array function in vtkm data set, you might doing the wrong things. Most of the function can be achieved by just doing the shallow copy. The array handle copy is also the shallow copy case. Always trying to ask yourself, if the deep copy is necessary when you want to use them.</p>
<h3 id="Device-primitives-this-is-still-one-key-research-direaction"><a href="#Device-primitives-this-is-still-one-key-research-direaction" class="headerlink" title="Device primitives (this is still one key research direaction)"></a>Device primitives (this is still one key research direaction)</h3><p>Still not sure how it works, what are connection between these parallel primitives and the upper level operations</p>
<h3 id="Filter-type"><a href="#Filter-type" class="headerlink" title="Filter type"></a>Filter type</h3><p>Classifiation different filter types from different categories is located in <a target="_blank" rel="noopener" href="https://docs.google.com/spreadsheets/d/1-T7rLSRfyjXLdG_EBJIVLy_cZDmH6kb95l8Umq0bkOY/edit?usp=sharing">this table</a>:</p>
<p><code>field_transform</code> transform fields from&#x2F;to the same entity<br><code>field_conversion</code> does sth cell to pointer or pointer to cell converion</p>
<h3 id="Iterate-the-specific-array"><a href="#Iterate-the-specific-array" class="headerlink" title="Iterate the specific array"></a>Iterate the specific array</h3><p>There is no direact way to do this things, we need to getdata firstly, then use the AsArrayHanle to transfer to dedicated handle then get the ReadPortal, then based on this ReadPortal or write Portal, we can read or write data. This may looks like a little bit redoundant, but it is how a framework works, you need to do things following its convention.</p>
<h3 id="Some-tips-for-code-standard"><a href="#Some-tips-for-code-standard" class="headerlink" title="Some tips for code standard"></a>Some tips for code standard</h3><p>Using DataSet::GetField with field name and association instead of GetPoint or GetField when getting a specific array.</p>
<h3 id="Initilization-and-Logging"><a href="#Initilization-and-Logging" class="headerlink" title="Initilization and Logging"></a>Initilization and Logging</h3><p>The initilization is interesting for vtkm, it needs to be at the place before the real operation to parse the argument in the program. The vtkm will remove the arguments started with the <code>--vtkm-sth</code>, so we need to set the initilization before the actual operation to parse the argument in the program. The log level can be set based on the <code>--vtkm-log-level</code>, different name of the log are specified <a target="_blank" rel="noopener" href="https://gitlab.kitware.com/vtk/vtk-m/-/blob/master/vtkm/cont/Logging.cxx#L111">here</a>, one useful things I know recently if the <code>Kern</code> log, it will print out a lot of kernel details, such as the cuda call etc, which is helpful for understanding these parallel details.</p>
<h3 id="Using-different-device-adaptor"><a href="#Using-different-device-adaptor" class="headerlink" title="Using different device adaptor"></a>Using different device adaptor</h3><p>There currently is no direct way to query on which device something ran on. One way you can do this is to turn on the logging level to Perf, but that will print out a lot of info that will be difficult to discern. </p>
<p>What I usually do is force a particular device. That way VTK-m will run on that device or else it will raise an error. The easiest way to force a device is to add a <code>--vtkm-device=openmp</code> command line argument (that gets passed to vtkm::cont::Initialize). Alternately, you can use ScopedRuntimeDeviceTracker to force a particular device (<a target="_blank" rel="noopener" href="https://docs-m.vtk.org/latest/structvtkm_1_1cont_1_1ScopedRuntimeDeviceTracker.html">https://docs-m.vtk.org/latest/structvtkm_1_1cont_1_1ScopedRuntimeDeviceTracker.html</a>).</p>
<p>Essentially, the vtkm is just a library for other dedicated service. Its location is a service which can be integrated into other service such as paraview.</p>
<p>Another way is just try to use the ForceDevice to set the backend as the expected one, such as this (<a target="_blank" rel="noopener" href="https://github.com/Kitware/VTK-m/blob/master/examples/multi_backend/MultiDeviceGradient.cxx#L60">https://github.com/Kitware/VTK-m/blob/master/examples/multi_backend/MultiDeviceGradient.cxx#L60</a>)</p>
<p>This is a example to use the initialization in vtkm (<br><a target="_blank" rel="noopener" href="https://github.com/Kitware/VTK-m/blob/master/examples/cosmotools/CosmoHaloFinder.cxx#L109">https://github.com/Kitware/VTK-m/blob/master/examples/cosmotools/CosmoHaloFinder.cxx#L109</a>)</p>
<p>Pay attention, if we set the backend as the openmp, and use the mpirun to run the program, the default case is that there will be one core in the program even for local env, this is a good we to bind multiple physical cores to one process&#x2F;task</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mpirun -np ncores --bind-to none -x OMP_NUM_THREADS=nthreads ./program</span><br></pre></td></tr></table></figure>

<h3 id="Timer"><a href="#Timer" class="headerlink" title="Timer"></a>Timer</h3><p>Same with the device adaptor, it is recommended to use the vtkm timer when measure the performance of specific filter. Otherwise, the timing is not accurate, maybe force the timer to be set as the default pattern when initilize the timer. Especially for the cuda device. </p>
<h3 id="Debug-strategies"><a href="#Debug-strategies" class="headerlink" title="Debug strategies"></a>Debug strategies</h3><p>In parallel programming, the debug operations is a little bit tricky. In vtkm, we can always start from the serial backend to do the debug operation. If the data set is large, there are also two strategeis, one is to generate small synthetic data set, another is to print out the results of the communication for specific thread. We can use the inner type workindex to index the thread. Each thread has a unique id. For the case of visitCellByPoints, the <code>WorkIndex</code> can label the spefic position of the cell, for example, the 0th id process the first cell, so on so forth. another convenient tag is the <code>InputIndex</code>, it produces a vtkm::Id that identifies the index of the input element, which can differ from the <code>WorkIndex</code> in a worklet with a scatter.</p>
<p>In addition, if we want to access the coordinates of the points in the worklet, the point coordinates can be made available by having a <code>FieldInPoint</code> input and passing the point coordinates array.</p>
<h3 id="The-poor-performance-of-the-debug-mode"><a href="#The-poor-performance-of-the-debug-mode" class="headerlink" title="The poor performance of the debug mode"></a>The poor performance of the debug mode</h3><p>When we set the vtk as debug mode, it might decrease the performance since it will add extra assertion operations for arrayhandle, check this place (<a target="_blank" rel="noopener" href="https://github.com/Kitware/VTK-m/blob/master/CMakeLists.txt#L137">https://github.com/Kitware/VTK-m/blob/master/CMakeLists.txt#L137</a>) to get more details.</p>
<p>Here we can see that the performance can increase a lot if we do not use extra VTKM assert</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Kitware/VTK-m/blob/master/vtkm/Assert.h#L42">https://github.com/Kitware/VTK-m/blob/master/vtkm/Assert.h#L42</a></p>
<p>This is also really common for the c programming, if we use the assert operation in the program, these assert operation only works when we use the DEBUG mode to complie the program.</p>
<h3 id="function-attribute-or-type"><a href="#function-attribute-or-type" class="headerlink" title="function attribute or type"></a>function attribute or type</h3><p>In CUDA, a function or method must be declared with the <code>__device__</code> modifier to run on the CUDA device. This tells the compiler to generate the machine code that the GPU understands. This <code>__device__</code> is hidden in the <code>VTKM_EXEC</code> or <code>VTKM_EXEC_CONT</code> in VTK-m. A function running on a device can only call other functions that run on the device. The worklet, which runs on the device, is trying to call functions&#x2F;methods in the Eigen library that are not marked <code>__device__</code>.</p>
<p>For example, there is <code>hidden</code> attribute without using the exec tag.</p>
<h3 id="Set-the-log-level-and-the-backend"><a href="#Set-the-log-level-and-the-backend" class="headerlink" title="Set the log level and the backend"></a>Set the log level and the backend</h3><p>These configurations are recomended to be set in the initilization function of the vtkm call. There are other operations to set the backend and the log levels, such as the ForceDevice function.</p>
<h3 id="CI-CD-and-management"><a href="#CI-CD-and-management" class="headerlink" title="CI CD and management"></a>CI CD and management</h3><p>The project management thing is maintained in this repo </p>
<p><a target="_blank" rel="noopener" href="https://gitlab.kitware.com/kmorel/ecp-vtk-m-project-management">https://gitlab.kitware.com/kmorel/ecp-vtk-m-project-management</a></p>
<p>Since this project includes multiple organizations, they use the open issue and associated labels to show the key functionality and the working progress, it is really clear. However, it might be good to link each specific item with specific gitlab issue.</p>
<p>Another good thing is the CI&#x2F;CD operation, once there is a new commit, the cdash is triggered and there are detailed results checking, such as the compiling warnings, the memory leak checking (compiler on different platforms have different warning complains) It is good to fix all these kind of issues before code merging.</p>
<h3 id="The-position-of-vtkm-multiprocess-programming"><a href="#The-position-of-vtkm-multiprocess-programming" class="headerlink" title="The position of vtkm, multiprocess programming"></a>The position of vtkm, multiprocess programming</h3><p>Originally, the vtkm only focuses on the parallel primitives on single node. There is a vtkh library calles the vtkm library and in charge of MPI program based on MPI program. It turns out that there introduce lots of depedency issue, some cases such as streamline need to handle all level of parallalism. So for the currnet vtkm, when designing a filter from vtkm’s perspective, both the parallelism from the single node and multiple nodes’s perspective need to be considered.</p>
<h3 id="Compiling-based-on-module"><a href="#Compiling-based-on-module" class="headerlink" title="Compiling based on module"></a>Compiling based on module</h3><p>The vtkm’s compiling process adopts similar pattern with the vtk’s pattern it adopts a moduler system to assist the compiling and linking process. There are several key word under the vtkm.module. Details can be found here (<a target="_blank" rel="noopener" href="https://gitlab.kitware.com/vtk/vtk-m/-/blob/master/docs/Modules.md">https://gitlab.kitware.com/vtk/vtk-m/-/blob/master/docs/Modules.md</a>)</p>
<h3 id="Other-small-tricks"><a href="#Other-small-tricks" class="headerlink" title="Other small tricks"></a>Other small tricks</h3><p>Once time, I try to use the Threshold and ThresholdPoints filter in vtkm. However, the output data set is not same with what I expected. The reason is that I forget to use the <code>SetCompactPoints(true)</code> without setting this parameter, the results are not the one we want.</p>
<h3 id="Mechanisms-in-filter-base-class"><a href="#Mechanisms-in-filter-base-class" class="headerlink" title="Mechanisms in filter base class"></a>Mechanisms in filter base class</h3><p>The filter base class provides a lot of common mechanisms used by filter. The common thing is set active field, that can set which field to apply on. The filter selection mechanism is also useful, it can control how to map the original data set to the final data set. It can control which field need to be skiped.</p>
<h3 id="Coordinates-system"><a href="#Coordinates-system" class="headerlink" title="Coordinates system"></a>Coordinates system</h3><p>Coordinates system is just a common filter. We can then label that filter as a coordinates. When we call the addCoordinates system, we just label a specific field into a coordinates system.</p>
<h3 id="Detailed-understading-about-the-ArrayHandle"><a href="#Detailed-understading-about-the-ArrayHandle" class="headerlink" title="Detailed understading about the ArrayHandle"></a>Detailed understading about the ArrayHandle</h3><p>At somepoints, we need to understand the array handle in detail from scratch to write the filter algorithm in more efficient way. TODO</p>
<h3 id="Tricks-of-adding-a-new-filter"><a href="#Tricks-of-adding-a-new-filter" class="headerlink" title="Tricks of adding a new filter"></a>Tricks of adding a new filter</h3><p>Remember setting export label</p>
<p>Remember adding .cxx file into the CMakeLists of current filter, that may cause the vtable error which shows that some virtual function is not implemented, the core issue is that the cxx file is not compiled by cmake!!!</p>
<p>Remember update CMakeLists in testing dir</p>
<p>Remember to update vtkm.module </p>
<h3 id="Scalable-design-of-VTKm"><a href="#Scalable-design-of-VTKm" class="headerlink" title="Scalable design of VTKm"></a>Scalable design of VTKm</h3><p>multiple filters<br>multiple worket and dispathers<br>multiple backends</p>
<p>Key interface of filters<br>Doexecution, input is a data set, return a data sets. input is multiple data sets, return a partitioned data sets. This can executed in a distributed manners.<br>Set some key properties of filter, such as the filed that the filter applied on or if the filter will be passed in the output results.</p>
<p>Key interface of the backends&#x2F;device adaptors</p>
<ul>
<li><p>Addeing tag that labels assocaited device</p>
</li>
<li><p>Query the associated device information, if the device exist on the current system.</p>
</li>
<li><p>Memory management, such as Allocate memory on device, copy data from device to host and copy data from device to host.</p>
</li>
<li><p>Set assocaited parameters for the runtime, such as number of threads and other associated information such as block number in grid and thread number in block etc.</p>
</li>
<li><p>Algorithm can be the most important part, such as the ScheduleKernel1d or 3d etc in a strided for loop</p>
</li>
<li><p>Other associated implementation such as the timer system, start time or stop time etc.</p>
</li>
</ul>
<p>the dispather is the core part that bridges control env with the execution env. We have a array in control env, then use dispatcher to call on worklet to make the worklet code execute on device with specific patterns.</p>
<p>Management of worklet (more details in the tutorial)</p>
<ul>
<li><p>Type checking, checking if the type of input parameter of worklet is compatible with the types specified by the ControlSignature defined in the worklet.</p>
</li>
<li><p>Transportation, dispatch mechanism plays a role here, it needs to load the data into the execution env before schduling a job. This is usually a part of dispatcher code. The transport class must contain an operator that turns the assocaited control argument into execution environment object. The ExecObjectType is the the type of the data after it is moved to execution env. It contains some information associated to devices.</p>
</li>
<li><p>Fetching,</p>
</li>
</ul>
<p>Typical workflow, MapField, VisitCellByPoints, VisitPointsByCell, ReducedByKey</p>
<p>Key interface regarding the worklet and dispather(more details can be found in tutorial):</p>
<p>checking parameters<br>create data on device<br>schedule corresponding algorithm</p>
<h3 id="Some-tricky-points"><a href="#Some-tricky-points" class="headerlink" title="Some tricky points"></a>Some tricky points</h3><p><strong>Sequences of visiting cells</strong><br>When visiting the cell by points, if the result cares about the sequence of visiting the point in cells, we may need to map the index output by vtkm to the correct one. For example, if the sequence of visiting each point of a cell is different with what provided by VTK-m, we need to add another function to map the point id to the one we wanted.</p>
<p><strong>Error messages based on templates</strong><br>Since VTKm uses templates in defining worklet, it might be tricky to parse these error information, just try to go back to the first places where the error message is generated. For instance, this is one example, in this example, I forget to implement the constructor, then I got a large amounut of output:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">(base) zw1@MAC132276 UCV$ make</span><br><span class="line">[ 50%] Linking CXX executable LoadEnsAndProcess</span><br><span class="line">Undefined symbols for architecture arm64:</span><br><span class="line">  &quot;CriticalPointWorklet::CriticalPointWorklet()&quot;, referenced from:</span><br><span class="line">      auto callCriticalPointWorklet(vtkm::cont::DataSet)::$_0::operator()&lt;vtkm::cont::ArrayHandleRecombineVec&lt;signed char&gt; &gt;(vtkm::cont::ArrayHandleRecombineVec&lt;signed char&gt;&amp;) const in LoadEnsAndProcess.cpp.o</span><br><span class="line">      auto callCriticalPointWorklet(vtkm::cont::DataSet)::$_0::operator()&lt;vtkm::cont::ArrayHandleRecombineVec&lt;unsigned char&gt; &gt;(vtkm::cont::ArrayHandleRecombineVec&lt;unsigned char&gt;&amp;) const in LoadEnsAndProcess.cpp.o</span><br><span class="line">      auto callCriticalPointWorklet(vtkm::cont::DataSet)::$_0::operator()&lt;vtkm::cont::ArrayHandleRecombineVec&lt;short&gt; &gt;(vtkm::cont::ArrayHandleRecombineVec&lt;short&gt;&amp;) const in LoadEnsAndProcess.cpp.o</span><br><span class="line">      auto callCriticalPointWorklet(vtkm::cont::DataSet)::$_0::operator()&lt;vtkm::cont::ArrayHandleRecombineVec&lt;unsigned short&gt; &gt;(vtkm::cont::ArrayHandleRecombineVec&lt;unsigned short&gt;&amp;) const in LoadEnsAndProcess.cpp.o</span><br><span class="line">      auto callCriticalPointWorklet(vtkm::cont::DataSet)::$_0::operator()&lt;vtkm::cont::ArrayHandleRecombineVec&lt;int&gt; &gt;(vtkm::cont::ArrayHandleRecombineVec&lt;int&gt;&amp;) const in LoadEnsAndProcess.cpp.o</span><br><span class="line">      auto callCriticalPointWorklet(vtkm::cont::DataSet)::$_0::operator()&lt;vtkm::cont::ArrayHandleRecombineVec&lt;unsigned int&gt; &gt;(vtkm::cont::ArrayHandleRecombineVec&lt;unsigned int&gt;&amp;) const in LoadEnsAndProcess.cpp.o</span><br><span class="line">      auto callCriticalPointWorklet(vtkm::cont::DataSet)::$_0::operator()&lt;vtkm::cont::ArrayHandleRecombineVec&lt;long long&gt; &gt;(vtkm::cont::ArrayHandleRecombineVec&lt;long long&gt;&amp;) const in LoadEnsAndProcess.cpp.o</span><br><span class="line">      ...</span><br><span class="line">ld: symbol(s) not found for architecture arm64</span><br><span class="line">clang: error: linker command failed with exit code 1 (use -v to see invocation)</span><br><span class="line">make[2]: *** [LoadEnsAndProcess] Error 1</span><br><span class="line">make[1]: *** [CMakeFiles/LoadEnsAndProcess.dir/all] Error 2</span><br><span class="line">make: *** [all] Error 2</span><br></pre></td></tr></table></figure>

<p>Only the first line and the latst line might be important, it is easy to get lost when the error is complicated.</p>
<h3 id="Rendering-system"><a href="#Rendering-system" class="headerlink" title="Rendering system"></a>Rendering system</h3><p>Associated pr about the parallel compositing.</p>
<p><a target="_blank" rel="noopener" href="https://gitlab.kitware.com/vtk/vtk-m/-/issues/802">https://gitlab.kitware.com/vtk/vtk-m/-/issues/802</a></p>
<h3 id="VTKm-dataset-vs-VTK-dataset"><a href="#VTKm-dataset-vs-VTK-dataset" class="headerlink" title="VTKm dataset vs VTK dataset"></a>VTKm dataset vs VTK dataset</h3><p>using merging dataset as example to analyse this thing.</p>
<h3 id="References"><a href="#References" class="headerlink" title="References"></a>References</h3><p>VTKmUserGuide</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2023/01/08/Many-faces-of-vtkm/" data-id="clt2e88mi002n8xjr6ako7of4" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
    
 
<script src="/jquery/jquery.min.js"></script>

  <div id="random_posts">
    <h2>推荐文章</h2>
    <div class="random_posts_ul">
      <script>
          var random_count =4
          var site = {BASE_URI:'/'};
          function load_random_posts(obj) {
              var arr=site.posts;
              if (!obj) return;
              // var count = $(obj).attr('data-count') || 6;
              for (var i, tmp, n = arr.length; n; i = Math.floor(Math.random() * n), tmp = arr[--n], arr[n] = arr[i], arr[i] = tmp);
              arr = arr.slice(0, random_count);
              var html = '<ul>';
            
              for(var j=0;j<arr.length;j++){
                var item=arr[j];
                html += '<li><strong>' + 
                item.date + ':&nbsp;&nbsp;<a href="' + (site.BASE_URI+item.uri) + '">' + 
                (item.title || item.uri) + '</a></strong>';
                if(item.excerpt){
                  html +='<div class="post-excerpt">'+item.excerpt+'</div>';
                }
                html +='</li>';
                
              }
              $(obj).html(html + '</ul>');
          }
          $('.random_posts_ul').each(function () {
              var c = this;
              if (!site.posts || !site.posts.length){
                  $.getJSON(site.BASE_URI + 'js/posts.js',function(json){site.posts = json;load_random_posts(c)});
              } 
               else{
                load_random_posts(c);
              }
          });
      </script>
    </div>
  </div>

    
<nav id="article-nav">
  
    <a href="/2023/01/08/git-lfs-tips/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">
        
          git lfs tips
        
      </div>
    </a>
  
  
    <a href="/2023/01/02/Non-linear-regression/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">Non linear regression</div>
    </a>
  
</nav>

  
</article>
 
     
  <div class="comments" id="comments">
    
     
       
      <div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
    
       
      
      
  </div>
 
  

</section>
           
    <aside id="sidebar">
  
    
    <div class="widget-wrap">
    
      <div class="widget" id="toc-widget-fixed">
      
        <strong class="toc-title">文章目录</strong>
        <div class="toc-widget-list">
              <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Decouple-between-the-execution-env-and-control-env"><span class="toc-number">1.</span> <span class="toc-text">Decouple between the execution env and control env</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Filter-plus-worklet-style"><span class="toc-number">2.</span> <span class="toc-text">Filter plus worklet style</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Type-detect-and-conversion"><span class="toc-number">3.</span> <span class="toc-text">Type detect and conversion</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CastAndCall-and-ListForEach"><span class="toc-number">4.</span> <span class="toc-text">CastAndCall and ListForEach</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Other-magics-of-the-array-handle"><span class="toc-number">5.</span> <span class="toc-text">Other magics of the array handle</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Call-the-worklet"><span class="toc-number">6.</span> <span class="toc-text">Call the worklet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Create-data-set-for-sample-testing"><span class="toc-number">7.</span> <span class="toc-text">Create data set for sample testing</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Visulization-with-data-parallel-primitives"><span class="toc-number">8.</span> <span class="toc-text">Visulization with data parallel primitives</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flexible-and-zero-copy-array-handle"><span class="toc-number">9.</span> <span class="toc-text">Flexible and zero-copy array handle</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Device-primitives-this-is-still-one-key-research-direaction"><span class="toc-number">10.</span> <span class="toc-text">Device primitives (this is still one key research direaction)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Filter-type"><span class="toc-number">11.</span> <span class="toc-text">Filter type</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Iterate-the-specific-array"><span class="toc-number">12.</span> <span class="toc-text">Iterate the specific array</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Some-tips-for-code-standard"><span class="toc-number">13.</span> <span class="toc-text">Some tips for code standard</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Initilization-and-Logging"><span class="toc-number">14.</span> <span class="toc-text">Initilization and Logging</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Using-different-device-adaptor"><span class="toc-number">15.</span> <span class="toc-text">Using different device adaptor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Timer"><span class="toc-number">16.</span> <span class="toc-text">Timer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Debug-strategies"><span class="toc-number">17.</span> <span class="toc-text">Debug strategies</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#The-poor-performance-of-the-debug-mode"><span class="toc-number">18.</span> <span class="toc-text">The poor performance of the debug mode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#function-attribute-or-type"><span class="toc-number">19.</span> <span class="toc-text">function attribute or type</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Set-the-log-level-and-the-backend"><span class="toc-number">20.</span> <span class="toc-text">Set the log level and the backend</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CI-CD-and-management"><span class="toc-number">21.</span> <span class="toc-text">CI CD and management</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#The-position-of-vtkm-multiprocess-programming"><span class="toc-number">22.</span> <span class="toc-text">The position of vtkm, multiprocess programming</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Compiling-based-on-module"><span class="toc-number">23.</span> <span class="toc-text">Compiling based on module</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Other-small-tricks"><span class="toc-number">24.</span> <span class="toc-text">Other small tricks</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mechanisms-in-filter-base-class"><span class="toc-number">25.</span> <span class="toc-text">Mechanisms in filter base class</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Coordinates-system"><span class="toc-number">26.</span> <span class="toc-text">Coordinates system</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Detailed-understading-about-the-ArrayHandle"><span class="toc-number">27.</span> <span class="toc-text">Detailed understading about the ArrayHandle</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tricks-of-adding-a-new-filter"><span class="toc-number">28.</span> <span class="toc-text">Tricks of adding a new filter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Scalable-design-of-VTKm"><span class="toc-number">29.</span> <span class="toc-text">Scalable design of VTKm</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Some-tricky-points"><span class="toc-number">30.</span> <span class="toc-text">Some tricky points</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Rendering-system"><span class="toc-number">31.</span> <span class="toc-text">Rendering system</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#VTKm-dataset-vs-VTK-dataset"><span class="toc-number">32.</span> <span class="toc-text">VTKm dataset vs VTK dataset</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#References"><span class="toc-number">33.</span> <span class="toc-text">References</span></a></li></ol>
          </div>
      </div>
    </div>

  
    

  
    
  
    
  
    

  
</aside>

      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-left">
      &copy; 2014 - 2024 zhe&nbsp;|&nbsp;
      主题 <a href="https://github.com/giscafer/hexo-theme-cafe/" target="_blank">Cafe</a>
    </div>
     <div id="footer-right">
      联系方式&nbsp;|&nbsp;godenwangzhe@gmail.com
    </div>
  </div>
</footer>
 
<script src="/jquery/jquery.min.js"></script>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
    <a href="/about" class="mobile-nav-link">关于</a>
  
</nav>
    <img class="back-to-top-btn" src="/images/fly-to-top.png"/>
<script>
// Elevator script included on the page, already.
window.onload = function() {
  var elevator = new Elevator({
    selector:'.back-to-top-btn',
    element: document.querySelector('.back-to-top-btn'),
    duration: 1000 // milliseconds
  });
}
</script>
      

  
    <script>
      var cloudTieConfig = {
        url: document.location.href, 
        sourceId: "",
        productKey: "e2fb4051c49842688ce669e634bc983f",
        target: "cloud-tie-wrapper"
      };
    </script>
    <script src="https://img1.ws.126.net/f2e/tie/yun/sdk/loader.js"></script>
    

  







<!-- author:forvoid begin -->
<!-- author:forvoid begin -->

<!-- author:forvoid end -->

<!-- author:forvoid end -->


  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      })
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      })
    </script>
    <script type="text/javascript" src="https://cdn.rawgit.com/mathjax/MathJax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  



 
<script src="/js/is.js"></script>



  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>


<script src="/js/elevator.js"></script>

  </div>
</body>
</html>